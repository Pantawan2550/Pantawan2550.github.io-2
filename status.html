<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ประวัติการเข้า-ออกคิว</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eef2f7;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    h2 {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      font-size: 16px;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    td {
      background-color: #f9f9f9;
    }
    .btn-group {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      color: white;
      min-width: 180px;
    }
    .sort-btn {
      background-color: #007bff;
    }
    .sort-btn:hover {
      background-color: #0056b3;
    }
    .clear-btn {
      background-color: #dc3545;
    }
    .clear-btn:hover {
      background-color: #c82333;
    }
    .restore-btn {
      background-color: #28a745;
    }
    .restore-btn:hover {
      background-color: #1e7e34;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDNkrcksSvU6H4xYf9h5hvWYgHFYuy4igw",
      authDomain: "queue-management-system-79b27.firebaseapp.com",
      databaseURL: "https://queue-management-system-79b27-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-management-system-79b27",
      storageBucket: "queue-management-system-79b27.appspot.com",
      messagingSenderId: "76344006886",
      appId: "1:76344006886:web:a93cdee9adf70b43e30327"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let sortAsc = false; // เริ่มต้นเรียงจากใหม่→เก่า (มาก→น้อย)

    function backupAndClear() {
      if (!confirm("ยืนยันการล้างประวัติแบบสำรองก่อน?")) return;

      db.ref("history").once("value").then(snapshot => {
        const data = snapshot.val();
        if (!data) {
          alert("ไม่มีข้อมูลประวัติให้สำรอง");
          return;
        }
        const timestamp = new Date().toISOString().replace(/[-:.]/g,"").slice(0,15);
        const backupRef = db.ref("history_backup/" + timestamp);

        backupRef.set(data).then(() => {
          return db.ref("history").remove();
        }).then(() => {
          alert("สำรองและล้างประวัติเรียบร้อยแล้ว");
        }).catch(err => alert("เกิดข้อผิดพลาด: " + err.message));
      });
    }

    function restoreBackup() {
      if (!confirm("ยืนยันการกู้คืนประวัติจากสำรองล่าสุด? ข้อมูลปัจจุบันจะถูกลบ")) return;

      db.ref("history_backup").orderByKey().limitToLast(1).once("value").then(snap => {
        const backups = snap.val();
        if (!backups) {
          alert("ไม่พบข้อมูลสำรอง");
          return;
        }
        const lastBackupKey = Object.keys(backups)[0];
        const lastBackupData = backups[lastBackupKey];

        db.ref("history").remove().then(() => {
          return db.ref("history").set(lastBackupData);
        }).then(() => {
          alert("กู้คืนข้อมูลสำเร็จ");
        }).catch(err => alert("เกิดข้อผิดพลาด: " + err.message));
      });
    }

    function toggleSort() {
      sortAsc = !sortAsc;
      renderTable(currentData);
      const btn = document.getElementById("sortBtn");
      btn.textContent = sortAsc ? "เรียงเวลาเข้า: น้อย → มาก" : "เรียงเวลาเข้า: มาก → น้อย";
    }

    let currentData = [];

    function renderTable(data) {
      const tbody = document.getElementById("historyBody");
      // sort by timeIn ตามสถานะ sortAsc
      const sorted = data.slice().sort((a,b) => {
        const tA = new Date(a.timeIn).getTime();
        const tB = new Date(b.timeIn).getTime();
        return sortAsc ? tA - tB : tB - tA;
      });

      tbody.innerHTML = "";
      for (const item of sorted) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.number}</td>
          <td>${item.timeIn ? new Date(item.timeIn).toLocaleTimeString("th-TH") : "-"}</td>
          <td>${item.startServiceTime ? new Date(item.startServiceTime).toLocaleTimeString("th-TH") : "-"}</td>
          <td>${item.timeOut ? new Date(item.timeOut).toLocaleTimeString("th-TH") : "-"}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    window.onload = function() {
      const tbody = document.getElementById("historyBody");
      db.ref("history").on("value", snapshot => {
        currentData = Object.values(snapshot.val() || {});
        renderTable(currentData);
      });

      // ตั้งชื่อปุ่มเริ่มต้น
      document.getElementById("sortBtn").textContent = "เรียงเวลาเข้า: มาก → น้อย";
    };
  </script>
</head>
<body>
  <div class="container">
    <h2>ประวัติการเข้า-ออกคิว</h2>
    <table>
      <thead>
        <tr>
          <th>หมายเลขคิว</th>
          <th>เวลาเข้า</th>
          <th>เวลาเริ่มให้บริการ</th>
          <th>เวลาออก</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>

    <div class="btn-group">
      <button id="sortBtn" class="sort-btn" onclick="toggleSort()"></button>
      <button class="clear-btn" onclick="backupAndClear()">ล้างประวัติแบบกู้คืนได้</button>
      <button class="restore-btn" onclick="restoreBackup()">กู้คืนประวัติจากสำรองล่าสุด</button>
    </div>
  </div>
</body>
</html>
